console.log("FLUF Chrome Extension content script loaded"),"undefined"!=typeof chrome&&chrome.runtime&&(document.documentElement.setAttribute("data-fluf-extension","installed"),document.documentElement.setAttribute("data-fluf-extension-version","1.0.0"),console.log("ðŸ” FLUF Extension: Set data-fluf-extension attribute")),window.dispatchEvent(new CustomEvent("flufExtensionReady",{detail:{version:"1.0.0",installed:!0}})),window.addEventListener("message",async function(e){if(!["http://localhost:10006","http://localhost:*","http://fluf.local","https://fluf.io"].includes(e.origin)&&e.origin!==window.location.origin)return void console.log("ðŸ”’ Rejected message from untrusted origin:",e.origin);const{type:o}=e.data,n=e.data.payload||e.data.data||{};if("FCU_VINTED_CREATE_LISTING"===o)console.log("ðŸ“¨ Content script received Vinted listing request from page"),chrome.runtime.sendMessage({action:"FCU_VINTED_CREATE_LISTING",...n},o=>{console.log("ðŸ“¨ Content script received response from background:",o),window.postMessage({type:"FCU_VINTED_CREATE_LISTING_RESPONSE",data:o},e.origin)});else if("FLUF_EXTENSION_STATUS_CHECK"===o||"FCU_CHECK_DEPOP_EXTENSION"===o||"FCU_CHECK_EXTENSION"===o)if(console.log("ðŸ” Extension status check received:",o),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage)console.log("ðŸ” Chrome runtime available, sending positive response"),chrome.runtime.sendMessage({action:"checkExtension"},function(e){console.log("ðŸ” Background script response:",e);const o={installed:!0,version:chrome.runtime.getManifest()?.version||"unknown",legacy_types:["FCU_DEPOP_EXTENSION_STATUS","FCU_CHECK_EXTENSION_RESPONSE"]};console.log("ðŸ” Sending FLUF_EXTENSION_STATUS_RESPONSE:",o),window.postMessage({type:"FLUF_EXTENSION_STATUS_RESPONSE",...o},"*"),console.log("ðŸ” Sending legacy FCU_DEPOP_EXTENSION_STATUS"),window.postMessage({type:"FCU_DEPOP_EXTENSION_STATUS",installed:!0,data:{installed:!0}},"*"),console.log("ðŸ” Sending legacy FCU_CHECK_EXTENSION_RESPONSE"),window.postMessage({type:"FCU_CHECK_EXTENSION_RESPONSE",installed:!0,data:{installed:!0}},"*")});else{console.error("ðŸ” Chrome extension runtime not available");const e={installed:!1,error:"Chrome extension runtime not available"};console.log("ðŸ” Sending error responses:",e),window.postMessage({type:"FLUF_EXTENSION_STATUS_RESPONSE",...e},"*"),window.postMessage({type:"FCU_DEPOP_EXTENSION_STATUS",...e},"*"),window.postMessage({type:"FCU_CHECK_EXTENSION_RESPONSE",...e},"*")}else if("FCU_GET_VINTED_COORDINATION_STATUS"===o){console.log("ðŸ”” Vinted coordination status check requested");try{chrome.runtime.sendMessage({action:"FCU_getVintedCoordinationStatus"},e=>{chrome.runtime.lastError?(console.error("ðŸ”” Extension context error:",chrome.runtime.lastError.message),window.postMessage({type:"FCU_VINTED_COORDINATION_STATUS_RESPONSE",data:{error:"Extension context invalidated"}},"*")):(console.log("ðŸ”” Coordination status response:",e),window.postMessage({type:"FCU_VINTED_COORDINATION_STATUS_RESPONSE",data:e},"*"))})}catch(e){console.error("ðŸ”” Error requesting coordination status:",e),window.postMessage({type:"FCU_VINTED_COORDINATION_STATUS_RESPONSE",data:{error:e.message}},"*")}}else if("FCU_CLOSE_DUPLICATE_VINTED_TABS"===o){console.log("ðŸ§¹ Duplicate Vinted tabs cleanup requested");try{chrome.runtime.sendMessage({action:"FCU_CLOSE_DUPLICATE_VINTED_TABS"},e=>{chrome.runtime.lastError?(console.error("ðŸ§¹ Extension context error:",chrome.runtime.lastError.message),window.postMessage({type:"FCU_CLOSE_DUPLICATE_VINTED_TABS_RESPONSE",data:{success:!1,error:"Extension context invalidated"}},"*")):(console.log("ðŸ§¹ Cleanup response:",e),window.postMessage({type:"FCU_CLOSE_DUPLICATE_VINTED_TABS_RESPONSE",data:e},"*"))})}catch(e){console.error("ðŸ§¹ Error requesting cleanup:",e),window.postMessage({type:"FCU_CLOSE_DUPLICATE_VINTED_TABS_RESPONSE",data:{success:!1,error:e.message}},"*")}}if("FLUF_MARKETPLACE_AUTH_REQUEST"===o||"FCU_TRIGGER_DEPOP_AUTH"===o||"FCU_GET_DEPOP_SESSION"===o||"FCU_GET_VINTED_SESSION"===o){console.log("ðŸ” Marketplace auth request received:",o),console.log("ðŸ” Full event.data:",e.data),console.log("ðŸ” Payload:",n);let t="depop";"FCU_GET_VINTED_SESSION"===o?t="vinted":"FCU_GET_DEPOP_SESSION"===o&&(t="depop"),n&&n.channel&&(t=n.channel),console.log("ðŸ” Channel determined:",t,"from type:",o,"payload channel:",n?.channel);const s=function(e){try{const o=`; ${document.cookie}`.split(`; ${e}=`);if(2===o.length){const n=o.pop().split(";").shift();return console.log(`Cookie '${e}' found:`,n?"[PRESENT]":"[EMPTY]"),n}return console.log(`Cookie '${e}' not found in:`,document.cookie.substring(0,100)+"..."),null}catch(e){return console.error("Error reading cookie:",e),null}}("fc_user_identifier"),r=function(){const e=document.getElementById("fc-user-identifier");return e?e.getAttribute("data-user-id")||e.textContent:window._currentUserID?window._currentUserID.toString():window._userIdentifier?window._userIdentifier.toString():null}(),i=s||r||n.userIdentifier||n?.data?.userIdentifier||"";console.log("ðŸ” USER IDENTIFIER DETECTION:"),console.log(" - From cookie:",s?`[FOUND: ${s}]`:"[NOT FOUND]"),console.log(" - From DOM:",r?`[FOUND: ${r}]`:"[NOT FOUND]"),console.log(" - From payload.userIdentifier:",n.userIdentifier?`[FOUND: ${n.userIdentifier}]`:"[NOT FOUND]"),console.log(" - From payload.data.userIdentifier:",n?.data?.userIdentifier?`[FOUND: ${n?.data?.userIdentifier}]`:"[NOT FOUND]"),console.log(" - Final choice:",i||"[NONE]"),console.log(" - Final userIdentifier value being sent:",i);const a="fluf.io"===window.location.hostname||"fluf.local"===window.location.hostname||"localhost"===window.location.hostname;if(console.log("Current domain:",window.location.hostname),console.log("Is FLUF domain:",a),a||s||console.warn("âš ï¸ Attempting to read fc_user_identifier cookie from non-FLUF domain. Cookie may not be available."),console.log("User identifier from cookie:",s),console.log("User identifier from payload.userIdentifier:",n.userIdentifier),console.log("User identifier from payload.data.userIdentifier:",n?.data?.userIdentifier),console.log("Final user identifier:",i),console.log("Channel:",t),console.log("Source URL:",n.sourceUrl||n?.data?.sourceUrl||window.location.origin),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage)try{chrome.runtime.sendMessage({action:"FCU_getTokenViaContentScript",sourceUrl:n.sourceUrl||n?.data?.sourceUrl||window.location.origin,userIdentifier:i,channel:t,base_url:n.base_url||n?.data?.base_url,country:n.country||n?.data?.country},function(e){if(chrome.runtime.lastError){console.error("ðŸ” Chrome runtime error:",chrome.runtime.lastError.message);const e={success:!1,error:"Extension context invalidated. Please refresh the page and try again.",channel:t,userIdentifier:i};return window.postMessage({type:"FLUF_MARKETPLACE_AUTH_RESPONSE",...e},"*"),window.postMessage({type:"FCU_DEPOP_AUTH_RESULT",...e},"*"),void("depop"===t?window.postMessage({type:"FCU_GET_DEPOP_SESSION_RESPONSE",data:e},"*"):"vinted"===t&&window.postMessage({type:"FCU_GET_VINTED_SESSION_RESPONSE",data:e},"*"))}const o={success:e?.success,error:e?.error,message:e?.message,channel:t,userIdentifier:i};console.log("ðŸ” Sending auth response to page:",o),window.postMessage({type:"FLUF_MARKETPLACE_AUTH_RESPONSE",...o},"*"),window.postMessage({type:"FCU_DEPOP_AUTH_RESULT",...o},"*"),"depop"===t?window.postMessage({type:"FCU_GET_DEPOP_SESSION_RESPONSE",data:o},"*"):"vinted"===t&&window.postMessage({type:"FCU_GET_VINTED_SESSION_RESPONSE",data:o},"*")})}catch(e){console.error("ðŸ” Error sending message to background script:",e);const o={success:!1,error:e.message.includes("Extension context invalidated")?"Extension context invalidated. Please refresh the page and try again.":"Failed to communicate with extension",channel:t,userIdentifier:i};window.postMessage({type:"FLUF_MARKETPLACE_AUTH_RESPONSE",...o},"*"),window.postMessage({type:"FCU_DEPOP_AUTH_RESULT",...o},"*"),"depop"===t?window.postMessage({type:"FCU_GET_DEPOP_SESSION_RESPONSE",data:o},"*"):"vinted"===t&&window.postMessage({type:"FCU_GET_VINTED_SESSION_RESPONSE",data:o},"*")}else{console.error("Chrome extension runtime not available for marketplace auth");const e={success:!1,error:"Chrome extension runtime not available",channel:t,userIdentifier:i};window.postMessage({type:"FLUF_MARKETPLACE_AUTH_RESPONSE",...e},"*"),window.postMessage({type:"FCU_DEPOP_AUTH_RESULT",...e},"*"),"depop"===t?window.postMessage({type:"FCU_GET_DEPOP_SESSION_RESPONSE",data:e},"*"):"vinted"===t&&window.postMessage({type:"FCU_GET_VINTED_SESSION_RESPONSE",data:e},"*")}}}),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener(function(e,o,n){console.log("Content script received message from background:",e),"VINTED_AUTH_RESTORED"===e.type&&(console.log("âœ… Vinted authentication restored - updating connection state"),window.postMessage({type:"VINTED_AUTH_RESTORED",userIdentifier:e.userIdentifier},"*"),n({success:!0}))}),window.addEventListener("fluf-extension-call",async e=>{const{method:o,data:n,requestId:t}=e.detail;let s;switch(o){case"createVintedListing":try{s=await chrome.runtime.sendMessage({action:"FCU_VINTED_CREATE_LISTING",...n})}catch(e){console.error("Content script error:",e),s=e.message&&e.message.includes("Extension context invalidated")?{success:!1,error:"Extension context invalidated. Please refresh the page and try again."}:{success:!1,error:e.message}}break;case"checkStatus":s={installed:!0,version:"1.0.0"};break;case"getVintedSession":try{s=await chrome.runtime.sendMessage({action:"FCU_getTokenViaContentScript",channel:"vinted",userIdentifier:n.userIdentifier,base_url:n.base_url||"https://www.vinted.co.uk/",country:n.country||"UK"})}catch(e){console.error("Content script error:",e),s=e.message&&e.message.includes("Extension context invalidated")?{success:!1,error:"Extension context invalidated. Please refresh the page and try again."}:{success:!1,error:e.message}}break;default:s={success:!1,error:"Unknown method"}}window.dispatchEvent(new CustomEvent("fluf-extension-response",{detail:{requestId:t,response:s}}))});