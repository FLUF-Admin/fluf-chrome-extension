const ENDPOINTS=["https://fluf.io/wp-json/fc/circular-auth/v1/token"],VINTED_DOMAINS=["www.vinted.at","www.vinted.be","www.vinted.cz","www.vinted.de","www.vinted.dk","www.vinted.es","www.vinted.fi","www.vinted.fr","www.vinted.gr","www.vinted.hr","www.vinted.hu","www.vinted.ie","www.vinted.it","www.vinted.lt","www.vinted.lu","www.vinted.nl","www.vinted.pl","www.vinted.pt","www.vinted.ro","www.vinted.se","www.vinted.sk","www.vinted.co.uk","www.vinted.com"],COUNTRY_TO_VINTED_DOMAIN={AT:"https://www.vinted.at/",BE:"https://www.vinted.be/",CZ:"https://www.vinted.cz/",DE:"https://www.vinted.de/",DK:"https://www.vinted.dk/",ES:"https://www.vinted.es/",FI:"https://www.vinted.fi/",FR:"https://www.vinted.fr/",GR:"https://www.vinted.gr/",HR:"https://www.vinted.hr/",HU:"https://www.vinted.hu/",IE:"https://www.vinted.ie/",IT:"https://www.vinted.it/",LT:"https://www.vinted.lt/",LU:"https://www.vinted.lu/",NL:"https://www.vinted.nl/",PL:"https://www.vinted.pl/",PT:"https://www.vinted.pt/",RO:"https://www.vinted.ro/",SE:"https://www.vinted.se/",SK:"https://www.vinted.sk/",GB:"https://www.vinted.co.uk/",UK:"https://www.vinted.co.uk/",US:"https://www.vinted.com/",DEFAULT:"https://www.vinted.co.uk/"};function isVintedDomain(e){try{const t=new URL(e).hostname;return VINTED_DOMAINS.includes(t)}catch(e){return!1}}function getVintedBaseUrl(e){return`https://${e}/`}function getCountryFromVintedUrl(e){return{"https://www.vinted.at/":"Austria","https://www.vinted.be/":"Belgium","https://www.vinted.cz/":"Czech Republic","https://www.vinted.de/":"Germany","https://www.vinted.dk/":"Denmark","https://www.vinted.es/":"Spain","https://www.vinted.fi/":"Finland","https://www.vinted.fr/":"France","https://www.vinted.gr/":"Greece","https://www.vinted.hr/":"Croatia","https://www.vinted.hu/":"Hungary","https://www.vinted.ie/":"Ireland","https://www.vinted.it/":"Italy","https://www.vinted.lt/":"Lithuania","https://www.vinted.lu/":"Luxembourg","https://www.vinted.nl/":"Netherlands","https://www.vinted.pl/":"Poland","https://www.vinted.pt/":"Portugal","https://www.vinted.ro/":"Romania","https://www.vinted.se/":"Sweden","https://www.vinted.sk/":"Slovakia","https://www.vinted.co.uk/":"UK","https://www.vinted.com/":"USA"}[e]||"UK"}async function getUserCountryFromIP(){try{debugLog("üåç Detecting user country from IP...");const e=await fetch("https://ipapi.co/country_code/",{method:"GET",headers:{"User-Agent":"FLUF-Extension/1.0"}});if(e.ok){const t=(await e.text()).trim().toUpperCase();return debugLog("üåç Detected country code:",t),t}return debugLog("‚ùå IP detection failed, using default"),"DEFAULT"}catch(e){return console.error("‚ùå Error detecting country from IP:",e),"DEFAULT"}}async function getVintedDomainPreference(){try{const e=await chrome.storage.local.get(["vinted_domain_preference"]);if(e.vinted_domain_preference)return debugLog("‚úÖ Using stored Vinted domain preference:",e.vinted_domain_preference),e.vinted_domain_preference;debugLog("üîç No stored Vinted domain preference, detecting from IP...");const t=await getUserCountryFromIP(),o=COUNTRY_TO_VINTED_DOMAIN[t]||COUNTRY_TO_VINTED_DOMAIN.DEFAULT;return await chrome.storage.local.set({vinted_domain_preference:o}),debugLog("üíæ Stored detected Vinted domain preference:",o),o}catch(e){return console.error("‚ùå Error getting Vinted domain preference:",e),COUNTRY_TO_VINTED_DOMAIN.DEFAULT}}async function updateVintedDomainPreference(e){try{await chrome.storage.local.set({vinted_domain_preference:e}),debugLog("üíæ Updated Vinted domain preference:",e)}catch(e){console.error("‚ùå Error updating Vinted domain preference:",e)}}async function getDepopTokensDirectly(){return debugLog("üîÑ SCHEDULED DEPOP CHECK"),await getDepopTokensViaContentScript()}async function getVintedTokensDirectly(){return debugLog("üîÑ SCHEDULED VINTED CHECK"),await getVintedTokensViaContentScript()}async function handleVintedAlarmCheck(){debugLog("üîî VINTED ALARM: Checking if refresh is needed...");try{const e=(await chrome.storage.local.get(["vinted_last_frontend_refresh"])).vinted_last_frontend_refresh||0,t=Date.now()-e,o=9e5;if(t<o){debugLog("üîî VINTED ALARM: Skipping - frontend refreshed",Math.round(t/6e4),"minutes ago");const e=o-t,s=Math.max(e+3e5,6e5);return debugLog("üîî VINTED ALARM: Rescheduling alarm for",Math.round(s/6e4),"minutes from now"),chrome.alarms.clear("FCU_checkVinted"),void chrome.alarms.create("FCU_checkVinted",{delayInMinutes:s/6e4,periodInMinutes:20})}debugLog("üîî VINTED ALARM: Proceeding with scheduled check"),getVintedTokensDirectly()}catch(e){console.error("üîî VINTED ALARM: Error checking coordination:",e),getVintedTokensDirectly()}}async function getVintedCoordinationStatus(){try{const e=(await chrome.storage.local.get(["vinted_last_frontend_refresh"])).vinted_last_frontend_refresh||0,t=Date.now()-e,o=(await chrome.alarms.getAll()).find(e=>"FCU_checkVinted"===e.name);return{lastFrontendRefresh:new Date(e).toISOString(),timeSinceLastRefresh:Math.round(t/6e4),nextAlarmTime:o?new Date(o.scheduledTime).toISOString():"No alarm scheduled",alarmPeriod:o?o.periodInMinutes:"N/A"}}catch(e){return{error:e.message}}}chrome.runtime.onInstalled.addListener(e=>{debugLog("Extension installed/updated:",e.reason),chrome.alarms.create("FCU_checkDepop",{periodInMinutes:360}),chrome.alarms.create("FCU_checkVinted",{periodInMinutes:20}),getTokenViaContentScript()}),initializeDebugMode(),chrome.alarms.create("FCU_checkDebugMode",{periodInMinutes:.5}),chrome.runtime.onMessage.addListener((e,t,o)=>{if("setDebugMode"===e.action)return debugModeEnabled=e.enabled,debugModeChecked=!0,debugLog("üîß Debug mode directly set to:",debugModeEnabled?"ENABLED":"DISABLED"),o({success:!0,debugEnabled:debugModeEnabled}),!0}),chrome.alarms.onAlarm.addListener(e=>{"FCU_checkDepop"===e.name?getDepopTokensDirectly():"FCU_checkVinted"===e.name?handleVintedAlarmCheck():"FCU_checkDebugMode"===e.name&&(debugModeCheckPromise=null,debugModeChecked=!1,checkDebugMode().then(e=>{e!==debugModeEnabled&&(debugModeEnabled=e,debugLog("üîß Debug mode changed to:",e?"ENABLED":"DISABLED"))}))}),chrome.webRequest.onBeforeSendHeaders.addListener(e=>{if(!isVintedDomain(e.url))return;const t=e.requestHeaders.find(e=>"cookie"===e.name.toLowerCase());t&&t.value&&(debugLog("üç™ VINTED XHR COOKIES CAPTURED:",t.value.length,"chars"),chrome.storage.local.set({vinted_captured_cookies:{cookies:t.value,timestamp:Date.now(),url:e.url}}))},{urls:VINTED_DOMAINS.map(e=>`*://${e}/*`)},["requestHeaders"]);let lastRequestInfo=null;chrome.webRequest.onHeadersReceived.addListener(e=>{if(!e||!e.url.includes("/items/new"))return;const t=e.responseHeaders.find(e=>"location"===e.name.toLowerCase());lastRequestInfo={status:e.statusCode,location:t?.value||null,url:e.url,time:Date.now()}},{urls:VINTED_DOMAINS.map(e=>`*://${e}/items/new*`)},["responseHeaders"]),chrome.webRequest.onHeadersReceived.addListener(e=>{if(!isVintedDomain(e.url))return;const t=e.responseHeaders.filter(e=>"set-cookie"===e.name.toLowerCase());t.length>0&&debugLog("üç™ VINTED SET-COOKIE HEADERS CAPTURED:",t.length,"headers")},{urls:VINTED_DOMAINS.map(e=>`*://${e}/*`)},["responseHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(e=>{if(!isVintedDomain(e.url))return;if(!(e.url.includes("/api/")||e.url.includes("/items/new")||e.url.includes("/account")||e.url.includes("/member/")))return;const t=e.requestHeaders.find(e=>"cookie"===e.name.toLowerCase());t&&t.value&&debugLog("üîç API CALL cookies captured from:",e.url)},{urls:VINTED_DOMAINS.map(e=>`*://${e}/*`)},["requestHeaders"]);let vintedCookiesExtractionLock=!1,globalVintedExtractionInProgress=!1,lastVintedAuthAttempt=0;const VINTED_AUTH_DEBOUNCE_MS=3e3;let debugModeEnabled=!1,debugModeChecked=!1,debugModeCheckPromise=null,lastVintedDebuggerCheck=0;const VINTED_DEBUGGER_COOLDOWN=9e5;function debugLog(...e){debugModeEnabled&&console.log(...e)}async function checkDebugMode(){return debugModeCheckPromise||(debugModeCheckPromise=(async()=>{try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});let t="https://fluf.io";if(e.length>0&&e[0].url)try{const o=new URL(e[0].url);("localhost"===o.hostname||o.hostname.includes("fluf.io")||o.hostname.includes("fluf.local"))&&(t=`${o.protocol}//${o.hostname}${o.port?":"+o.port:""}`)}catch(e){}const o=await fetch(`${t}/wp-json/fc/v1/debug/status`,{method:"GET",headers:{"Content-Type":"application/json"}});if(o.ok){const e=await o.json();debugModeEnabled=e.debug_enabled||!1,debugModeChecked=!0,debugLog("üîß Debug mode status:",debugModeEnabled?"ENABLED":"DISABLED")}else debugModeEnabled=!1,debugModeChecked=!0,debugLog("üîß Debug mode check failed, defaulting to disabled")}catch(e){debugModeEnabled=!1,debugModeChecked=!0,debugLog("üîß Debug mode check error:",e)}return debugModeEnabled})(),debugModeCheckPromise)}async function initializeDebugMode(){try{await checkDebugMode()}catch(e){debugModeEnabled=!1,debugModeChecked=!0,debugLog("üîß Debug mode initialization error:",e)}}async function getVintedCookiesWithDevTools(e="https://www.vinted.co.uk/",t=!1){if(!t){const e=Date.now()-lastVintedDebuggerCheck;if(e<9e5){const t=Math.ceil((9e5-e)/6e4);return debugLog(`‚è∞ VINTED: Cookie check rate limited. Please wait ${t} more minutes or use manual trigger.`),{success:!1,message:`Rate limited. Please wait ${t} more minutes or use manual trigger.`,rateLimited:!0}}}if(globalVintedExtractionInProgress&&!t)return debugLog("üîí VINTED: Global extraction already in progress in another window, skipping..."),{success:!1,message:"Vinted authentation already in progress in another window",rateLimited:!0};if(globalVintedExtractionInProgress&&t&&debugLog("üîì VINTED: Manual trigger detected - bypassing global coordination lock"),vintedCookiesExtractionLock&&!t){for(debugLog("üîí VINTED: Authentication already in progress, waiting...");vintedCookiesExtractionLock;)await new Promise(e=>setTimeout(e,100));debugLog("üîì VINTED: Previous authentication completed, retrying...")}let o;vintedCookiesExtractionLock&&t&&debugLog("üîì VINTED: Manual trigger detected - bypassing local authentication lock"),vintedCookiesExtractionLock=!0,globalVintedExtractionInProgress=!0,debugLog("üöÄ VINTED: Starting robust cookie extraction with tab management..."),debugLog("üéØ Target URL:",e);let s=!1,n=!1;try{const t=await chrome.windows.getCurrent(),r=await chrome.tabs.query({windowId:t.id,url:VINTED_DOMAINS.map(e=>`*://${e}/*`)});if(r.length>0)debugLog("üì± Using existing Vinted tab:",r[0].url),o=r[0],s=!1,debugLog("üîÑ Refreshing existing Vinted tab to ensure fresh session..."),await chrome.tabs.reload(o.id),await new Promise(e=>{const t=(s,n)=>{s===o.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),e())};chrome.tabs.onUpdated.addListener(t),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(t),e()},9e4)}),debugLog("‚úÖ Existing Vinted tab refreshed and loaded");else{debugLog("üì± Creating new Vinted tab...");const t=e.replace(/\/$/,"")+"/items/new";o=await chrome.tabs.create({url:t,active:!1}),s=!0,n=!0,debugLog("üì± Created new tab with URL:",t),await new Promise(e=>{const t=(s,n)=>{s===o.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),e())};chrome.tabs.onUpdated.addListener(t),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(t),e()},9e4)}),debugLog("‚úÖ New Vinted tab loaded")}if(debugLog("üì± Tab ID:",o.id),debugLog("üç™ VINTED: Extracting cookies using chrome.cookies.getAll..."),!chrome.cookies||!chrome.cookies.getAll)throw new Error("chrome.cookies.getAll API not available. Extension may need cookies permission.");const i=new URL(e).hostname;let c;try{c=await chrome.cookies.getAll({domain:i})}catch(e){throw debugLog("‚ùå VINTED: Error accessing cookies:",e),new Error("Failed to access cookies. Extension may need cookies permission: "+e.message)}if(debugLog(`üìä VINTED: Found ${c.length} cookies for domain ${i}`),!i.startsWith("www.")){const e="www."+i,t=await chrome.cookies.getAll({domain:e});c.push(...t),debugLog(`üìä VINTED: Found ${t.length} additional cookies for www.${i}`)}const a=c.filter((e,t,o)=>t===o.findIndex(t=>t.name===e.name&&t.domain===e.domain));debugLog(`üéØ VINTED: Found ${a.length} unique Vinted cookies`),debugLog("üç™ VINTED cookies:",a.map(e=>`${e.name} (httpOnly: ${e.httpOnly}, secure: ${e.secure}, domain: ${e.domain})`));const d=a.find(e=>"access_token_web"===e.name),u=a.find(e=>"anon_id"===e.name),g=a.find(e=>e.name.includes("session"));if(debugLog("üîç VINTED: Critical cookie check:"),debugLog(" - access_token_web:",d?"‚úÖ FOUND":"‚ùå MISSING"),debugLog(" - anon_id:",u?"‚úÖ FOUND":"‚ùå MISSING"),debugLog(" - session cookie:",g?"‚úÖ FOUND":"‚ùå MISSING"),!d&&s&&n){debugLog("‚ö†Ô∏è VINTED: Critical cookies missing from new tab, implementing retry logic...");for(let e=1;e<=5;e++){debugLog(`üîÑ VINTED: Retry attempt ${e}/5 - waiting 2 minutes before retry...`),await new Promise(e=>setTimeout(e,12e4));try{if(!await chrome.tabs.get(o.id)){debugLog("‚ùå VINTED: Tab was closed, stopping retries");break}let t;debugLog(`üîÑ VINTED: Refreshing tab for retry attempt ${e}`),await chrome.tabs.reload(o.id),await new Promise(e=>{const t=(s,n)=>{s===o.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),e())};chrome.tabs.onUpdated.addListener(t),setTimeout(()=>{chrome.tabs.onUpdated.removeListener(t),e()},9e4)});try{t=await chrome.cookies.getAll({domain:i})}catch(t){debugLog(`‚ùå VINTED: Error accessing cookies on retry ${e}:`,t);continue}if(t.find(e=>"access_token_web"===e.name)){debugLog(`‚úÖ VINTED: Success on retry attempt ${e}! Found access_token_web`),a.length=0,a.push(...t);break}debugLog(`‚ùå VINTED: Retry attempt ${e} failed - still no access_token_web`)}catch(t){debugLog(`‚ùå VINTED: Error checking tab status on retry ${e}:`,t);break}}}s&&n&&debugLog("üîí VINTED: Keeping new tab open as requested (not closing)");const l=a.find(e=>"access_token_web"===e.name);if(!l)return debugLog("‚ùå VINTED: access_token_web not found after all attempts - user not logged in"),{success:!1,message:"access_token_web cookie not found. Please log into Vinted.",cookies:a.map(e=>e.name),cookieCount:a.length,tabKeptOpen:s&&n};const h=a.map(e=>`${e.name}=${e.value}`).join("; ");return debugLog("‚úÖ VINTED: Success! Extracted",a.length,"cookies"),debugLog("üîë VINTED access_token_web:",l.value.substring(0,20)+"..."),lastVintedDebuggerCheck=Date.now(),{success:!0,cookieString:h,accessTokenWeb:l.value,anonId:a.find(e=>"anon_id"===e.name)?.value||null,totalCookies:a.length,cookies:a,tabKeptOpen:s&&n}}catch(e){return debugLog("‚ùå VINTED: Error:",e),s&&n&&debugLog("üîí VINTED: Keeping tab open despite error (as requested)"),{success:!1,message:e.message,tabKeptOpen:s&&n}}finally{vintedCookiesExtractionLock=!1,globalVintedExtractionInProgress=!1,debugLog("üîì VINTED: Locks released")}}async function getVintedHeadersCookies(e="https://www.vinted.co.uk/",t=!1){debugLog("üîÑ VINTED: Using chrome.cookies.getAll for cookie extraction...");const o=await getVintedCookiesWithDevTools(e,t);if(o.success)return o.cookieString;throw new Error(o.message||"Failed to extract Vinted cookies")}async function getVintedTokensViaContentScript(e="",t=null,o=!1){if(o="manual_trigger"===e||o,debugLog("üü£ VINTED TOKEN EXTRACTION"),!o){const e=Date.now(),t=e-lastVintedAuthAttempt;if(t<VINTED_AUTH_DEBOUNCE_MS)return debugLog(`‚è∏Ô∏è VINTED: Debouncing duplicate auth attempt (${t}ms since last attempt)`),{success:!1,message:"Duplicate auth attempt debounced",debounced:!0};lastVintedAuthAttempt=e}debugModeChecked||await checkDebugMode(),t?(debugLog("üîÑ Updating stored Vinted domain preference to:",t),await updateVintedDomainPreference(t)):t=await getVintedDomainPreference(),debugLog("üîç Using base URL:",t),debugLog("üîç Using userIdentifier:",e);try{debugLog("‚ùå access_token_web cookie not found - attempting authentication...");const s=await getVintedHeadersCookies(t,o);if(!s)return debugLog("‚ùå No Vinted cookies found"),{success:!1,message:"No cookies found"};const n=s.includes("access_token_web=");if(debugLog("üîç FINAL cookie check:",{access_token_web:n?"‚úÖ PRESENT":"‚ùå MISSING"}),!n){debugLog("üîÑ CRITICAL COOKIES MISSING - triggering session refresh..."),debugLog("üí° Missing cookies indicate expired session, attempting refresh...");try{const r=await handleVintedSessionRefresh({userIdentifier:e,hasValidSession:n,validateSession:!0,autoRefresh:!0,base_url:t});if(r.success){debugLog("‚úÖ Session refresh successful, retrying token extraction...");const n=await getVintedHeadersCookies(t,o);if(n){s=n,debugLog("‚úÖ Updated cookies after refresh");try{chrome.tabs.query({active:!0,currentWindow:!0},function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,{type:"VINTED_AUTH_RESTORED",userIdentifier:e})})}catch(e){debugLog("Could not notify frontend of auth restoration:",e)}}}else debugLog("‚ùå Session refresh failed:",r.error)}catch(e){debugLog("‚ùå Session refresh error:",e)}}let r=null;const i=s.match(/v_uid=([^;]+)/);if(i&&(r=i[1],debugLog("‚úÖ Extracted user ID from v_uid cookie:",r)),!r){const e=s.match(/access_token_web=([^;]+)/);if(e&&e[1])try{const t=e[1].split(".");if(3===t.length){const e=JSON.parse(atob(t[1]));r=e.user_id||e.sub||e.id,debugLog("‚úÖ Extracted user ID from JWT:",r)}}catch(e){debugLog("‚ùå Could not decode JWT token:",e.message)}}return sendTokenToAPI({channel:"vinted",fullCookies:s,userId:r,vintedUsername:null,hasAccessTokenWeb:n,baseUrl:t},t,e,null),console.groupEnd(),{success:!0,message:"Tokens found and sent to API"}}catch(e){return console.error("üí• Error extracting Vinted tokens:",e),console.groupEnd(),{success:!1,error:e.message}}}async function getDepopTokensViaContentScript(e=""){console.group("üü° DEPOP TOKEN EXTRACTION");try{debugLog("üîç Searching for existing Depop tabs...");let t=await chrome.tabs.query({url:["*://*.depop.com/*","*://depop.com/*"]});debugLog("üîç Found Depop tabs:",t.length);let o,s=!1,n=null;if(0===t.length){debugLog("üì± Creating new Depop tab...");const e=await chrome.tabs.create({url:"https://www.depop.com",active:!1});n=e.id,s=!0,debugLog("üì± Created new Depop tab with ID:",n),debugLog("‚è≥ Waiting for Depop page to load..."),await new Promise(t=>{const o=function(s,n,r){debugLog("üîß Tab update event:",s,n.status),s===e.id&&"complete"===n.status&&(debugLog("‚úÖ Depop page loaded successfully"),chrome.tabs.onUpdated.removeListener(o),t())};chrome.tabs.onUpdated.addListener(o),setTimeout(()=>{debugLog("‚è∞ Depop page load timeout - proceeding anyway"),chrome.tabs.onUpdated.removeListener(o),t()},1e4)}),debugLog("‚úÖ Depop tab loaded successfully")}else debugLog("üì± Using existing Depop tab:",t[0].url),n=t[0].id;debugLog("üîß Attempting to inject content script into Depop tab:",n),debugLog("üîß Tab URL:",t.length>0?t[0].url:"New tab");try{o=await chrome.scripting.executeScript({target:{tabId:n},func:()=>{function e(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}console.log("üîß Content script injected successfully into Depop page");const t=document.cookie;console.log("üîß All cookies:",t);const o=e("access_token"),s=e("user_id");return console.log("üîß DEPOP COOKIES FOUND:",t.length,"chars"),console.log("üîß - access_token:",o?"[PRESENT]":"[MISSING]"),console.log("üîß - user_id:",s?"[PRESENT]":"[MISSING]"),console.log("üîß - Full cookie string:",t.substring(0,200)+"..."),{success:!(!o||!s),accessToken:o,userId:s,allCookies:t,sourceUrl:"https://www.depop.com"}}})}catch(e){return console.error("üí• Script injection error:",e),debugLog("üîß Injection error details:",e.message),s&&n&&(debugLog("üóÇÔ∏è Closing Depop tab that was created (injection error)"),chrome.tabs.remove(n)),console.groupEnd(),{success:!1,message:"Script injection failed: "+e.message,error:e.message}}if(debugLog("üîß Content script injection results:",o),o&&o[0]&&o[0].result){const t=o[0].result;if(debugLog("üîß Content script result:",t),t.success){debugLog("‚úÖ DEPOP SUCCESS: Both access token and user ID found");return sendTokenToAPI({channel:"depop",accessToken:t.accessToken,userId:t.userId},t.sourceUrl,e,null),s&&n&&(debugLog("üóÇÔ∏è Closing Depop tab that was created for token extraction"),chrome.tabs.remove(n)),console.groupEnd(),{success:!0,message:"Tokens found and sent to API"}}return debugLog("‚ùå DEPOP FAIL: Missing required tokens"),s&&n&&(debugLog("üóÇÔ∏è Closing Depop tab that was created (missing tokens)"),chrome.tabs.remove(n)),console.groupEnd(),{success:!1,message:"User not logged in"}}{console.error("‚ùå DEPOP FAIL: Content script returned unexpected results"),console.error("üîß Results object:",o),console.error("üîß Results length:",o?o.length:"null"),console.error("üîß First result:",o&&o[0]?o[0]:"null"),debugLog("‚ùå DEPOP FAIL: Content script injection failed"),debugLog("üîß Results object:",o),debugLog("üîß Results length:",o?o.length:"null"),debugLog("üîß First result:",o&&o[0]?o[0]:"null"),s&&n&&(debugLog("üóÇÔ∏è Closing Depop tab that was created (injection failed)"),chrome.tabs.remove(n)),console.groupEnd();let e="Unknown error";return o?o[0]?o[0].result||(e="Result object is missing or undefined"):e="Results array is empty":e="No results returned from script execution",{success:!1,message:"Content script injection failed: "+e,error:e}}}catch(e){return console.error("üí• Error extracting Depop tokens:",e),debugLog("üîß Error details:",e),debugLog("üîß Error stack:",e.stack),console.groupEnd(),{success:!1,error:e.message}}}async function handleVintedSessionRefresh(e){debugLog("üîÑ VINTED SESSION REFRESH: Starting enhanced session refresh...");const t=e.userIdentifier,o=e.hasValidSession,s=e.validateSession;try{if(s&&!o){debugLog("üîÑ VINTED SESSION REFRESH: Session appears expired, trying API refresh first...");try{const t=(e.base_url||"https://www.vinted.co.uk/").replace(/\/$/,"");if(!(await fetch(t+"/api/v2/sessions",{method:"POST",headers:{"User-Agent":navigator.userAgent,"Content-Type":"application/json"}})).ok)throw debugLog("üîÑ VINTED SESSION REFRESH: API refresh failed, falling back to tab method..."),new Error("API refresh failed");debugLog("üîÑ VINTED SESSION REFRESH: API refresh successful, proceeding with token extraction..."),await new Promise(e=>setTimeout(e,1e3))}catch(e){debugLog("üîÑ VINTED SESSION REFRESH: API refresh error, using tab fallback:",e.message);await openVintedRefreshTab(baseUrl)?(debugLog("üîÑ VINTED SESSION REFRESH: Tab refresh succeeded, waiting before token extraction..."),await new Promise(e=>setTimeout(e,2e3))):debugLog("üîÑ VINTED SESSION REFRESH: Both API and tab refresh failed")}}const n=await getVintedTokensViaContentScript(t,baseUrl);return n&&n.success?(debugLog("üîÑ VINTED SESSION REFRESH: Tokens extracted successfully"),{success:!0,message:"Vinted session refresh completed successfully",channel:"vinted",hasValidSession:!0}):(debugLog("üîÑ VINTED SESSION REFRESH: Token extraction failed"),{success:!1,message:n?.message||"Failed to extract Vinted tokens",channel:"vinted",hasValidSession:!1,requiresRefresh:!0})}catch(e){return console.error("üîÑ VINTED SESSION REFRESH: Error during refresh:",e),{success:!1,error:e.message,channel:"vinted",hasValidSession:!1,requiresRefresh:!0}}}async function openVintedRefreshTab(e="https://www.vinted.co.uk/"){return new Promise(t=>{debugLog("üîÑ Using base URL:",e);const o=e.replace(/\/$/,""),s=`${o}/items/new`,n=[`${o}/items/new`,`${o}/member/signup/select_type*`];chrome.tabs.create({url:s,active:!1},e=>{if(chrome.runtime.lastError)return console.error("üîÑ VINTED SESSION REFRESH: Error creating tab:",chrome.runtime.lastError),void t(!1);let s=!1,r=null;const i=async t=>{t.tabId===e.id?(r=t.url,debugLog("üîÑ VINTED SESSION REFRESH: WebRequest detected:",r),s=!0,r.startsWith(`${o}/items/new`)?(debugLog("üîÑ VINTED SESSION REFRESH: Success - redirected to new item page"),d(!0)):r.includes("/signup")||r.includes("/login")?(debugLog("üîÑ VINTED SESSION REFRESH: Failure - redirected to signup/login"),d(!1)):(debugLog("üîÑ VINTED SESSION REFRESH: Unknown redirect, treating as success"),d(!0))):debugLog("üîÑ VINTED SESSION REFRESH: Different tab ID, ignoring")},c=(t,o,n)=>{t!==e.id||s||"complete"===o.status&&(debugLog("üîÑ VINTED SESSION REFRESH: Tab completed loading:",n.url),s||(n.url&&n.url.includes("/items/new")?(debugLog("üîÑ VINTED SESSION REFRESH: Tab update - success"),d(!0)):n.url&&(n.url.includes("/login")||n.url.includes("/signup"))&&(debugLog("üîÑ VINTED SESSION REFRESH: Tab update - failure"),d(!1))))};chrome.webRequest.onCompleted.addListener(i,{urls:n}),chrome.tabs.onUpdated.addListener(c);const a=setTimeout(()=>{s||(debugLog("üîÑ VINTED SESSION REFRESH: Timeout waiting for refresh (20s)"),debugLog("üîÑ VINTED SESSION REFRESH: Last known URL:",r||"none"),d(!1))},2e4),d=o=>{s=!0,clearTimeout(a),chrome.webRequest.onCompleted.removeListener(i),chrome.tabs.onUpdated.removeListener(c),chrome.tabs.remove(e.id,()=>{debugLog("üîÑ VINTED SESSION REFRESH: Refresh tab closed, success:",o),t(o)})}})})}function getTokenViaContentScript(e="",t=null,o=""){debugLog("Starting getTokenViaContentScript for sourceUrl:",e),debugLog("Using userIdentifier:",o);const s=""===o&&""===e;console.group("üöÄ Checking Both Platforms"),debugLog("üìã Starting parallel checks for Depop and Vinted...");let n=0,r=[],i=!1;debugLog("üü° Initiating Depop check..."),getDepopTokensViaContentScript(o).then(e=>{if(e&&e.success?(debugLog("‚úÖ Depop check completed successfully"),r.push({platform:"Depop",success:!0,data:{channel:"depop"}})):(debugLog("‚ùå Depop check completed but no data sent to API"),r.push({platform:"Depop",success:!1,error:e?e.message:"Unknown error"})),n++,2===n&&!i&&t){i=!0;const e=r.filter(e=>e.success);debugLog(`üèÅ Both checks complete: ${e.length}/2 successful`),console.groupEnd(),t({success:e.length>0,results:r,message:`Checked 2 platforms, ${e.length} successful`})}else 2===n&&(debugLog(`üèÅ Both checks complete: ${r.filter(e=>e.success).length}/2 successful`),console.groupEnd())}).catch(e=>{if(console.error("‚ùå Depop extraction failed:",e),r.push({platform:"Depop",success:!1,error:e.message}),n++,2===n&&!i&&t){i=!0;const e=r.filter(e=>e.success);debugLog(`üèÅ Both checks complete: ${e.length}/2 successful`),console.groupEnd(),t({success:e.length>0,results:r,message:`Checked 2 platforms, ${e.length} successful`})}else 2===n&&(debugLog(`üèÅ Both checks complete: ${r.filter(e=>e.success).length}/2 successful`),console.groupEnd())}),debugLog("üü£ Initiating Vinted check..."),getVintedTokensViaContentScript(s?"manual_trigger":o).then(e=>{if(e&&e.success?(debugLog("‚úÖ Vinted check completed successfully"),r.push({platform:"Vinted",success:!0,data:{channel:"vinted"}})):(debugLog("‚ùå Vinted check completed but no data sent to API"),r.push({platform:"Vinted",success:!1,error:e?e.message:"Unknown error"})),n++,2===n&&!i&&t){i=!0;const e=r.filter(e=>e.success);debugLog(`üèÅ Both checks complete: ${e.length}/2 successful`),console.groupEnd(),t({success:e.length>0,results:r,message:`Checked 2 platforms, ${e.length} successful`})}else 2===n&&(debugLog(`üèÅ Both checks complete: ${r.filter(e=>e.success).length}/2 successful`),console.groupEnd())}).catch(e=>{if(console.error("‚ùå Vinted extraction failed:",e),r.push({platform:"Vinted",success:!1,error:e.message}),n++,2===n&&!i&&t){i=!0;const e=r.filter(e=>e.success);debugLog(`üèÅ Both checks complete: ${e.length}/2 successful`),console.groupEnd(),t({success:e.length>0,results:r,message:`Checked 2 platforms, ${e.length} successful`})}else 2===n&&(debugLog(`üèÅ Both checks complete: ${r.filter(e=>e.success).length}/2 successful`),console.groupEnd())})}async function handleVintedListingCreation(e){debugLog("üöÄ VINTED LISTING: Starting listing creation process"),debugLog("üìã VINTED LISTING: Request data:",{fid:e.fid,vid:e.vid,uid:e.uid});const{payload:t,headers:o,endpoint:s,method:n,fid:r,vid:i,uid:c,cookies:a}=e,d=a||o&&o.cookies||null;if(!r)throw new Error("Missing required parameter: fid");if(!i)throw new Error("Missing required parameter: vid");if(!c)throw new Error("Missing required parameter: uid");debugLog(`‚úÖ VINTED LISTING: Parameters validated - FID: ${r}, VID: ${i}, UID: ${c}`);try{let e;if(s){const t=new URL(s);e=`${t.protocol}//${t.hostname}/`}else e=await getVintedDomainPreference();debugLog("üéØ Using dynamic Vinted domain for listing creation:",e);let u=null;try{u=await getVintedHeadersCookies(e,!0),debugLog("‚úÖ VINTED LISTING: Got fresh cookies from extension")}catch(e){debugLog("‚ö†Ô∏è VINTED LISTING: Extension cookie extraction failed:",e.message),d&&d.trim()?(u=d.trim(),debugLog("üîÑ VINTED LISTING: Using backend-provided cookies as fallback"),debugLog("üìä VINTED LISTING: Backend cookie length:",u.length),debugLog("üç™ VINTED LISTING: Backend cookie source:",a?"direct cookies param":"headers.cookies")):debugLog("‚ùå VINTED LISTING: No backend cookies provided as fallback")}if(!u)throw new Error("No Vinted cookies found - user needs to authenticate");const g=u.includes("access_token_web=");if(debugLog("üîç access_token_web check:",g?"‚úÖ PRESENT":"‚ùå MISSING"),!g)throw new Error("Missing access_token_web cookie - Vinted session expired");const l=e.replace(/\/$/,""),h={Cookie:u,"User-Agent":navigator.userAgent,Referer:`${l}/items/new`,Origin:l,"Content-Type":"application/json",Accept:"application/json, text/plain, */*","Accept-Language":"en-uk-fr","X-Enable-Multiple-Size-Groups":"true","X-Upload-Form":"true","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin"};o&&o.anon_id&&(h["X-Anon-Id"]=o.anon_id,debugLog("üÜî VINTED LISTING: Added anon ID from backend")),o&&o.csrf_token?(h["X-CSRF-token"]=o.csrf_token,debugLog("üîê VINTED LISTING: Added CSRF token from backend")):debugLog("‚ö†Ô∏è VINTED LISTING: No CSRF token provided - request may fail"),debugLog("üì° VINTED LISTING: Making request to:",s),debugLog("üì¶ VINTED LISTING: Payload size:",JSON.stringify(t).length,"chars");const p=await fetch(s,{method:n||"POST",headers:h,body:JSON.stringify(t),redirect:"manual"});debugLog("üì° VINTED LISTING: Response status:",p.status);const b=await p.json();if(p.ok&&b.item&&b.item.id){debugLog("‚úÖ VINTED LISTING: Success! Item ID:",b.item.id);await sendVintedCallbackToWordPress({success:!0,item_id:b.item.id,fid:r,vid:i,uid:c});return{success:!0,item_id:b.item.id,item_url:`${l}/items/${b.item.id}`,channel:"vinted"}}{debugLog("‚ùå VINTED LISTING: Failed with response:",b);let e="Failed to list on Vinted",o=null;if(b.errors){if(Array.isArray(b.errors)){const t=b.errors.map(e=>"object"==typeof e&&null!==e?e.message||e.text||JSON.stringify(e):String(e)).filter(e=>e&&"{}"!==e);e=t.length>0?t.join(", "):"Validation errors occurred"}else if("object"==typeof b.errors){const t=Object.values(b.errors).flat().map(e=>"object"==typeof e&&null!==e?e.message||e.text||JSON.stringify(e):String(e)).filter(e=>e&&"{}"!==e);e=t.length>0?t.join(", "):"Validation errors occurred"}}else b.message&&(e=b.message);return debugLog("üîç VINTED ERROR: Extracted message:",e),b.code&&(o=b.code),await sendVintedCallbackToWordPress({success:!1,location:"else",error:e,error_code:o,fid:r,vid:i,uid:c,response:b,body:t}),{success:!1,error:e,error_code:o,channel:"vinted"}}}catch(e){return console.error("üí• VINTED LISTING: Exception:",e),await sendVintedCallbackToWordPress({success:!1,location:"try-catch",error:e.message,fid:r,vid:i,uid:c,body:t}),{success:!1,error:e.message,channel:"vinted"}}}async function sendVintedCallbackToWordPress(e){debugLog("üì§ Sending callback to FLUF:",e);const t=["http://localhost:10006/wp-json/fc/listings/v1/vinted-extension-callback","https://fluf.io/wp-json/fc/listings/v1/vinted-extension-callback"];let o=null;const s=[];for(const n of t)try{debugLog(`üîÑ Trying callback endpoint: ${n}`);const t=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const e=await t.json();debugLog(`‚úÖ Callback successful at ${n}:`,e),s.push({endpoint:n,success:!0,result:e}),o||(o=e)}else debugLog(`‚ùå Callback failed at ${n}: ${t.status} ${t.statusText}`),s.push({endpoint:n,success:!1,status:t.status})}catch(e){console.error(`‚ùå Callback error at ${n}:`,e),s.push({endpoint:n,success:!1,error:e.message})}const n=s.filter(e=>e.success).length;return debugLog(`üìä Callback summary: ${n} successful, ${s.length-n} failed out of ${s.length} endpoints`),o?(debugLog("‚úÖ Returning first successful result"),o):(debugLog("‚ùå All callback endpoints failed"),null)}function sendTokenToAPI(e,t="",o="",s=null){const{accessToken:n,userId:r,channel:i,fullCookies:c,anonId:a,vintedUsername:d,baseUrl:u}=e;if(!i)return debugLog("No channel detected"),void(s&&s({success:!1,error:"No channel detected"}));if(!("depop"!==i||n&&r))return debugLog("No Depop token or user_id found"),void(s&&s({success:!1,error:"No Depop token or user_id found"}));if("vinted"===i&&!c)return debugLog("No Vinted cookies found"),void(s&&s({success:!1,error:"No Vinted cookies found"}));debugLog("Sending data to both localhost and production endpoints");let g={channel:i};if("depop"===i)g.token=n,g.user_id=r;else if("vinted"===i){g.cookies=c;const e=c.includes("access_token_web");if(debugLog("üîç VERIFYING VINTED COOKIES:"),debugLog(" - access_token_web present:",e?"‚úÖ YES":"‚ùå NO"),debugLog(" - Total cookie string length:",c.length),e){const e=c.match(/access_token_web=([^;]+)/);e&&(debugLog(" - access_token_web value length:",e[1].length),debugLog(" - access_token_web preview:",e[1].substring(0,50)+"..."))}if(r&&(g.user_id=r),a&&(g.anon_id=a),d&&(g.vinted_username=d),g.has_access_token_web=e,u){g.base_url=u;const e=getCountryFromVintedUrl(u);e&&(g.country=e)}}if(debugLog("üîç DEBUG: userIdentifier parameter:",o,"type:",typeof o),o?(g.userIdentifier=o,debugLog("‚úÖ Using WordPress user identifier:",o)):debugLog("‚ùå No userIdentifier provided - this will cause issues!"),debugLog("Sending data to API:",{...g,cookies:g.cookies?"[REDACTED]":void 0}),debugLog("Endpoints:",ENDPOINTS),"vinted"===i&&(debugLog("üü£ VINTED API DATA:"),debugLog(" - base_url:",g.base_url),debugLog(" - country:",g.country),debugLog(" - user_id:",g.user_id),debugLog(" - has_access_token_web:",g.has_access_token_web)),debugLog("Source URL:",t),debugLog("User Identifier:",o),debugLog("Channel:",i),"vinted"===i&&g.cookies){debugLog("üìã FINAL VINTED COOKIE VALIDATION:"),debugLog(" - Total cookies being sent:",g.cookies.split(";").length),debugLog(" - Cookie names being sent:",g.cookies.split(";").map(e=>e.split("=")[0].trim()).join(", ")),debugLog(" - access_token_web included:",g.cookies.includes("access_token_web")?"‚úÖ YES":"‚ùå NO"),debugLog(" - vinted_fr_session included:",g.cookies.includes("vinted_fr_session")?"‚úÖ YES":"‚ùå NO"),debugLog(" - anon_id included:",g.cookies.includes("anon_id")?"‚úÖ YES":"‚ùå NO");const e=["access_token_web","anon_id"].filter(e=>!g.cookies.includes(e));e.length>0?debugLog("‚ö†Ô∏è WARNING: Missing critical cookies for crosslisting:",e.join(", ")):debugLog("‚úÖ All critical cookies present for crosslisting")}const l=ENDPOINTS.map(e=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).then(async t=>{if(debugLog(`API response status for ${e}:`,t.status),t.ok){const o=await t.json();return{endpoint:e,success:!0,data:o}}{let o=`${t.status} ${t.statusText}`;try{const e=await t.text();e&&(o+=` - ${e}`)}catch(e){}return console.error(`‚ùå API Error for ${e}:`,o),{endpoint:e,success:!1,error:o}}}).catch(t=>(console.error(`‚ùå Network Error for ${e}:`,t),{endpoint:e,success:!1,error:t.message})));Promise.all(l).then(e=>{debugLog("All API responses:",e);const t=e.filter(e=>e.success);e.filter(e=>!e.success);t.length>0?(logStatus("Data sent successfully",!0),s&&s({success:!0,data:t[0].data,channel:i,results:e})):s&&s({success:!1,error:errorMessage,channel:i,results:e})})}function logStatus(e,t){chrome.storage.local.set({FCU_lastCheck:{message:e,success:t,timestamp:(new Date).toISOString()}})}chrome.runtime.onMessage.addListener((e,t,o)=>{if("FCU_getStatus"===e.action)return chrome.storage.local.get("FCU_lastCheck",e=>{o(e.FCU_lastCheck||{message:"No checks performed yet"})}),!0;if("FCU_checkNow"===e.action)debugLog("üîÑ MANUAL CHECK INITIATED from popup - checking both platforms (bypassing rate limits)..."),debugLog('‚ö†Ô∏è  WARNING: This is a legacy "check all platforms" action from the extension popup'),debugLog("‚ö†Ô∏è  For channel-specific auth, use FCU_getTokenViaContentScript with channel parameter"),getTokenViaContentScript(),o({message:"Check initiated"});else if("checkExtension"===e.action)o({installed:!0});else{if("FCU_getVintedCoordinationStatus"===e.action)return getVintedCoordinationStatus().then(e=>{o(e)}).catch(e=>{o({error:e.message})}),!0;if("FCU_VINTED_CREATE_LISTING"===e.action)return debugLog("üöÄ VINTED LISTING: Received create listing request from FLUF"),debugLog("Request data:",e),handleVintedListingCreation(e).then(e=>{debugLog("‚úÖ VINTED LISTING: Result:",e),o(e)}).catch(e=>{console.error("‚ùå VINTED LISTING: Error:",e),o({success:!1,error:e.message||"Unknown error",channel:"vinted"})}),!0;if("FCU_getTokenViaContentScript"===e.action){debugLog("Received getTokenViaContentScript via content.js message"),debugLog("Request data:",e);const t=e.channel||"depop";if(debugLog(`üîê CHANNEL-SPECIFIC AUTH: Processing ${t.toUpperCase()} authentication request`),debugLog(`üîê CHANNEL ISOLATION: Will ONLY authenticate ${t.toUpperCase()}, not other platforms`),"vinted"===t){const t=e.base_url;debugLog("üü£ Processing Vinted auth request with baseUrl:",t),chrome.storage.local.set({vinted_last_frontend_refresh:Date.now()}),debugLog("üîî VINTED COORDINATION: Recorded frontend refresh timestamp"),getVintedTokensViaContentScript(e.userIdentifier,t,!0).then(e=>{debugLog("üü£ Vinted auth result:",e);const t={success:e?.success||!1,error:e?.success?null:e?.message||e?.error||"Unknown error",message:e?.success?e?.message:null,channel:"vinted"};debugLog("üü£ Sending Vinted response to content script:",t),o(t)}).catch(e=>{console.error("üü£ Vinted auth error:",e);const t={success:!1,error:e.message||"Unknown error",channel:"vinted"};debugLog("üü£ Sending Vinted error response:",t),o(t)})}else debugLog("üü° Processing Depop auth request"),debugLog("üü° DEPOP ONLY: Will authenticate ONLY Depop, not Vinted or other platforms"),getDepopTokensViaContentScript(e.userIdentifier).then(e=>{debugLog("üü° Depop auth result:",e);const t={success:e?.success||!1,error:e?.success?null:e?.message||e?.error||"Unknown error",message:e?.success?e?.message:null,channel:"depop"};debugLog("üü° Sending Depop response to content script:",t),o(t)}).catch(e=>{console.error("üü° Depop auth error:",e);const t={success:!1,error:e.message||"Unknown error",channel:"depop"};debugLog("üü° Sending Depop error response:",t),o(t)});return!0}}});